+++
date = 2015-06-11
path = "2015/06/11/cve-2015-1788-openssl-binpoly-hang"
template = "page.html"
title = "CVE-2015-1788: OpenSSL ECC binpoly denial of service"
extra = { toc = true }
tags = ["security", "openssl", "https", "ssl", "tls"]
+++

When parsing an ASN.1 ECParameters structure OpenSSL enters
an infinite loop if the curve specified is over a specially
malformed binary polynomial field.

This can be used to perform denial of service against any
system which processes public keys, certificate requests or
certificates.  This includes TLS clients, TLS servers with
client authentication enabled, and assorted offline certificate
processing/issuance infrastructure.

# PoC

    $ curl https://binpoly.jbp.io:4433

or

    $ openssl s_client -connect binpoly.jbp.io:4433

If you have an affected library, these commands will hang using lots of CPU.
If you have a fixed library, you will get an error.

Note: this test server does not have a whole TLS stack.  It talks just enough TLS
to trigger the bug.

# Disclosure timeline

 *    **2015-03-30** - Discovery and confusion.
 *    **2015-04-01** - Enlightenment.  Preparation of testing improvements and patches.
 *    **2015-04-06** - Reported to OpenSSL security team.
 *    **2015-04-07** - Vendor confirmation, CVE-2015-1788 assigned.
 *    **2015-04-08** - Disclosure scheduled.
 *    **2015-06-08** - Release publicly announced.
 *    **2015-06-11** - Public release and disclosure.

# Details

The following conditions are needed to trigger this bug:

1. **Invalid explitely-defined elliptic curve over a binary polynomial field**.
   Named curves are not affected.  Prime field curves are not affected.
   The polynomial should be irreducible mod 2; the bug is triggered when it is not.
2. **Compressed curve base point**.  The `ECParameters` processing code decompresses
   such points during parsing: this means the bug gets triggered earlier rather than
   later.

The bug itself is in `BN_GF2m_mod_inv`.  This function contains a loop which will only
complete if the polynomial it is operating over is irreducible.

# Bug history

* **2002-08-02** - code [originally added][1dc920c8de5b7109727a21163843feecdf06a8cf] with bug present.
* **2011-05-04** - original `BN_GF2m_mod_inv` commented-out.  New [optimised version added][034688ec4d0e3d350dc0ee9602552f92e8889fc0].
* **2011-06-22** - patch fixing this bug [applied to commented-out code][8038e7e44c6060398f0793e3e16db0ad1ee95b9d].

[1dc920c8de5b7109727a21163843feecdf06a8cf]: https://github.com/openssl/openssl/commit/1dc920c8de5b7109727a21163843feecdf06a8cf
[8038e7e44c6060398f0793e3e16db0ad1ee95b9d]: https://github.com/openssl/openssl/commit/8038e7e44c6060398f0793e3e16db0ad1ee95b9d
[034688ec4d0e3d350dc0ee9602552f92e8889fc0]: https://github.com/openssl/openssl/commit/034688ec4d0e3d350dc0ee9602552f92e8889fc0

# Discovery

The following trivial program parses a DER-encoded `ECParameters` structure.

```c
#include <stdio.h>
#include <stdint.h>
#include <stdio.h>
#include <assert.h>

#include <openssl/ec.h>

int main(int argc, char **argv)
{
    unsigned char buf[1024];
    assert(argc == 2);
    FILE *f = fopen(argv[1], "rb");
    assert(f);
    size_t r = fread(buf, 1, 1024, f);
    printf("read = %zu\n", r);
    unsigned char *ptr = buf;
    EC_GROUP *ecg = d2i_ECPKParameters(NULL, &ptr, r);
    if (ecg)
    EC_GROUP_free(ecg);
    return 0;
}
```

This program and a few sample `ECParameters` encodings were given to
[American Fuzzy Lop][afl].  A full cycle took 22 hours.

[afl]: http://lcamtuf.coredump.cx/afl/

# Fork status

 * BoringSSL deleted this code.
 * LibreSSL has the affected code and is thought to be vulnerable (untested).

# Original report

 * [**Full write up**][report].
 * [fix1.patch][fix1patch] - reinstates fixed version, deletes fast version.
 * [fix2.patch][fix2patch] - fixes fast version, deletes slow version.
 * [tests.patch][testspatch] - regression testing and general testing improvements.
 * [original-cert.der][originalcertder] - a basic certificate.
 * [broken-cert.der][brokencertder] - manually-broken version of that certificate.
 * [cert.diff][certdiff] - annotated diff of certificate edits to trigger to bug.

[report]: https://raw.githubusercontent.com/ctz/vulns/master/openssl-01/readme.md
[fix1patch]: https://raw.githubusercontent.com/ctz/vulns/master/openssl-01/fix1.patch
[fix2patch]: https://raw.githubusercontent.com/ctz/vulns/master/openssl-01/fix2.patch
[testspatch]: https://raw.githubusercontent.com/ctz/vulns/master/openssl-01/tests.patch
[originalcertder]: https://raw.githubusercontent.com/ctz/vulns/master/openssl-01/original-cert.der
[brokencertder]: https://raw.githubusercontent.com/ctz/vulns/master/openssl-01/broken-cert.der
[certdiff]: https://raw.githubusercontent.com/ctz/vulns/master/openssl-01/cert.diff
